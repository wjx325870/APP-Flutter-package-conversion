name: 快速构建APK
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 核心改变：使用预配置好的Flutter Docker镜像，避免环境配置问题
    container:
      image: cirrusci/flutter:3.16.0

    steps:
      # 1. 获取代码（包含你的ZIP文件）
      - uses: actions/checkout@v4

      # 2. 解压并构建项目（极度简化）
      - name: 解压并构建
        run: |
          echo "=== 解压项目文件 ==="
          unzip -o LuaMobileIDE-LUS.zip
          
          echo "=== 进入项目目录 ==="
          cd LuaMobileIDE
          
          echo "=== 验证项目结构 ==="
          ls -la
          [ -f "pubspec.yaml" ] && echo "✅ pubspec.yaml 存在"
          
          echo "=== 开始构建APK ==="
          flutter clean
          flutter pub get
          
          # 使用最简化的构建命令
          flutter build apk --release --no-tree-shake-icons
          
          echo "=== 构建完成 ==="
          ls -lh build/app/outputs/flutter-apk/

      # 3. 上传APK文件
      - name: 上传APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: LuaMobileIDE/build/app/outputs/flutter-apk/app-release.apk
