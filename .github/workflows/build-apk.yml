name: Build APK from ZIP
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库代码（会包含你上传的ZIP文件）
      - uses: actions/checkout@v4

      # 2. 设置Java环境（Android构建必需）
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. 安装Flutter及Android SDK（关键：自动接受许可证）
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          android: true
          android-licenses: accept

      # 4. 解压ZIP、进入项目目录并构建
      - name: Extract, Setup and Build
        run: |
          # 解压你上传的ZIP文件（假设它位于仓库根目录，名为LuaMobileIDE-LUS.zip）
          unzip -o LuaMobileIDE-LUS.zip
          
          # 关键：进入解压后得到的项目文件夹
          cd LuaMobileIDE
          
          # 打印当前目录，确认文件
          echo "当前工作目录:"
          pwd
          ls -la
          
          # Flutter 清理、获取依赖、构建APK
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons --verbose

      # 5. 上传构建产物（APK文件）供下载
      - uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          # 注意：因为上一步 cd 进入了 LuaMobileIDE，所以APK生成路径也变了
          path: LuaMobileIDE/build/app/outputs/flutter-apk/app-release.apk
