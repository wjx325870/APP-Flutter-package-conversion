name: 最终构建尝试
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码（包含你的ZIP文件）
      - uses: actions/checkout@v4

      # 2. 设置 Java 环境（Android构建必需）
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. 安装 Flutter（仅使用官方支持参数，确保无报错）
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0' # 使用一个稍旧但极其稳定的版本
          # 注意：不传递任何 `android-` 开头的参数

      # 4. 手动配置 Android 环境与许可证（最可靠的方式）
      - name: 手动配置 Android 环境
        run: |
          echo "=== 步骤 1: 设置 Android SDK 基础路径 ==="
          # 定义 Android SDK 路径（GitHub Actions 通常在此路径有工具）
          ANDROID_SDK_ROOT=$HOME/androidsdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          mkdir -p $ANDROID_SDK_ROOT

          echo "=== 步骤 2: 尝试通过 sdkmanager 安装必要组件 ==="
          # 尝试安装最基础的 Android 命令行工具和平台
          # 使用 yes 管道自动接受所有提示
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-33" > /dev/null 2>&1 || echo "组件安装可能已跳过或失败，继续..."

          echo "=== 步骤 3: 写入许可证文件（解决构建失败的关键） ==="
          mkdir -p $ANDROID_SDK_ROOT/licenses
          # 写入 Android SDK 许可证的哈希值（这是“接受”许可证的官方方式）
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          echo -e "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-arm-dbt-license
          echo "✅ 手动环境配置完成"

      # 5. 验证环境
      - name: 验证构建环境
        run: |
          echo "=== 环境报告 ==="
          echo "Flutter 版本:"
          flutter --version
          echo ""
          echo "Java 版本:"
          java -version
          echo ""
          echo "Android SDK 根目录:"
          echo $ANDROID_SDK_ROOT
          ls -la $ANDROID_SDK_ROOT/licenses/ 2>/dev/null || echo "许可证目录可能不存在"

      # 6. 解压你的项目并构建（核心步骤）
      - name: 构建项目
        run: |
          echo "=== 开始构建流程 ==="
          
          echo "1. 解压项目 ZIP..."
          unzip -o LuaMobileIDE-LUS.zip
          
          echo "2. 进入项目目录..."
          cd LuaMobileIDE
          echo "当前目录: $(pwd)"
          ls -la
          
          echo "3. 清理并获取依赖..."
          flutter clean
          flutter pub get
          
          echo "4. 开始构建 Release APK（请耐心等待）..."
          # 使用最精简的参数构建
          flutter build apk --release --no-tree-shake-icons
          
          echo "5. 构建完成！检查输出："
          ls -lh build/app/outputs/flutter-apk/

      # 7. 上传生成的 APK
      - name: 上传 APK 文件
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: LuaMobileIDE/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 3
