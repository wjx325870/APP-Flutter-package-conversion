name: Build APK from LuaMobileIDE ZIP
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: '3.16.0'

    steps:
      # 1. 拉取仓库代码
      - uses: actions/checkout@v4

      # 2. 设置Java 17环境
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. 安装Android SDK（使用社区维护的Action）
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          licenses: accept

      # 4. 安装Flutter（仅安装Flutter，不带Android参数）
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # 5. 验证环境
      - name: Verify Environment
        run: |
          echo "=== 环境信息 ==="
          java -version
          flutter --version
          echo "ANDROID_HOME: $ANDROID_HOME"
          ls -la $ANDROID_HOME

      # 6. 解压、进入项目目录并构建
      - name: Extract and Build Project
        run: |
          echo "=== 处理ZIP文件 ==="
          
          # 检查ZIP文件
          ls -lh *.zip
          
          # 解压ZIP文件
          unzip -o LuaMobileIDE-LUS.zip
          
          # 进入项目目录
          cd LuaMobileIDE
          
          echo "=== 项目结构 ==="
          pwd
          ls -la
          
          echo "=== 核心文件检查 ==="
          [ -f "pubspec.yaml" ] && echo "✅ pubspec.yaml存在" || echo "❌ pubspec.yaml缺失"
          [ -d "lib" ] && echo "✅ lib目录存在" || echo "❌ lib目录缺失"
          [ -d "android" ] && echo "✅ android目录存在" || echo "❌ android目录缺失"
          
          # 显示pubspec.yaml内容
          echo "=== pubspec.yaml内容 ==="
          head -20 pubspec.yaml
          
          echo "=== 开始构建流程 ==="
          flutter clean
          flutter pub get
          
          # 构建APK（去掉日志上传部分，简化流程）
          flutter build apk --release --no-tree-shake-icons

      # 7. 上传APK文件
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: LuaMobileIDE/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
